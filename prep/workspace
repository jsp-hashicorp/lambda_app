provider "tfe" {
    token = var.tfe_token
}

# creating Org for workspaces
resource "tfe_organization" "test" {
  name = var.org_name
  email = "jsp@hashicorp.com"
}

# creating VCS Integration for the Org.
resource "tfe_oauth_client" "test" {
  organization     = tfe_organization.test.name
  api_url          = "https://api.github.com"
  http_url         = "https://github.com"
  oauth_token      = var.p_token
  service_provider = "github"
}

# Creating WorkSpace on Existing Org.
# 기 생성된 조직 아래 WorkSpace를 생성하는 경우, tfe_organization과 tfe_oauth_client 생성없이 작업할 것.
# 단, 이때 oauth_token_id는 VCS Integration에서 확인 후 설정 필요
resource "tfe_workspace" "test" {
  name         = var.ws_name
  organization = tfe_organization.test.name

  vcs_repo {
      identifier = 	var.repo_id  
      oauth_token_id = tfe_oauth_client.test.oauth_token_id
  }
}

resource "tfe_variable" "code_version" {
  key          = "code_version"
  value        = var.code_version
  category     = "terraform"
  sensitive    = false
  workspace_id = tfe_workspace.test.id
}